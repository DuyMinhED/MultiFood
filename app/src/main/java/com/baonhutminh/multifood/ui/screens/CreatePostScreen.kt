package com.baonhutminh.multifood.ui.screens\n\nimport android.net.Uri\nimport androidx.activity.compose.rememberLauncherForActivityResult\nimport androidx.activity.result.contract.ActivityResultContracts\nimport androidx.compose.foundation.Image\nimport androidx.compose.foundation.layout.*\nimport androidx.compose.foundation.lazy.LazyRow\nimport androidx.compose.foundation.lazy.items\nimport androidx.compose.foundation.rememberScrollState\nimport androidx.compose.foundation.text.KeyboardOptions\nimport androidx.compose.foundation.verticalScroll\nimport androidx.compose.material.icons.Icons\nimport androidx.compose.material.icons.automirrored.filled.ArrowBack\nimport androidx.compose.material.icons.filled.AddAPhoto\nimport androidx.compose.material.icons.filled.Star\nimport androidx.compose.material3.*\nimport androidx.compose.runtime.*\nimport androidx.compose.ui.Alignment\nimport androidx.compose.ui.Modifier\nimport androidx.compose.ui.draw.clip\nimport androidx.compose.ui.graphics.Color\nimport androidx.compose.ui.layout.ContentScale\nimport androidx.compose.ui.platform.LocalContext\nimport androidx.compose.ui.text.input.ImeAction\nimport androidx.compose.ui.text.input.KeyboardType\nimport androidx.compose.ui.unit.dp\nimport androidx.hilt.navigation.compose.hiltViewModel\nimport coil.compose.rememberAsyncImagePainter\nimport com.baonhutminh.multifood.viewmodel.CreatePostEvent\nimport com.baonhutminh.multifood.viewmodel.CreatePostUiState\nimport com.baonhutminh.multifood.viewmodel.CreatePostViewModel\n\n@OptIn(ExperimentalMaterial3Api::class)\n@Composable\nfun CreatePostScreen(\n    viewModel: CreatePostViewModel = hiltViewModel(),\n    onNavigateBack: () -> Unit\n) {\n    val uiState by viewModel.uiState\n\n    // Lắng nghe sự kiện điều hướng\n    LaunchedEffect(Unit) {\n        viewModel.events.collect {\n            if (it is CreatePostEvent.NavigateBack) {\n                onNavigateBack()\n            }\n        }\n    }\n\n    val imagePickerLauncher = rememberLauncherForActivityResult(\n        contract = ActivityResultContracts.GetMultipleContents(),\n        onResult = { uris: List<Uri> -> viewModel.onImageSelected(uris) }\n    )\n\n    Scaffold(\n        topBar = {\n            TopAppBar(\n                title = { Text(\"Tạo bài đăng mới\") },\n                navigationIcon = {\n                    IconButton(onClick = onNavigateBack) {\n                        Icon(Icons.AutoMirrored.Filled.ArrowBack, contentDescription = \"Quay lại\")\n                    }\n                },\n                actions = {\n                    Button(\n                        onClick = { viewModel.submitPost() },\n                        enabled = uiState !is CreatePostUiState.Loading\n                    ) {\n                        Text(\"Đăng\")\n                    }\n                }\n            )\n        }\n    ) {\ paddingValues ->\n        Box(modifier = Modifier.fillMaxSize()) {\n            Column(\n                modifier = Modifier\n                    .padding(paddingValues)\n                    .padding(16.dp)\n                    .verticalScroll(rememberScrollState())\n            ) {\n                OutlinedTextField(\n                    value = viewModel.placeName.value,\n                    onValueChange = { viewModel.placeName.value = it },\n                    label = { Text(\"Tên nhà hàng / quán ăn\") },\n                    modifier = Modifier.fillMaxWidth(),\n                    singleLine = true,\n                    keyboardOptions = KeyboardOptions(imeAction = ImeAction.Next)\n                )\n                Spacer(modifier = Modifier.height(8.dp))\n                OutlinedTextField(\n                    value = viewModel.placeAddress.value,\n                    onValueChange = { viewModel.placeAddress.value = it },\n                    label = { Text(\"Địa chỉ\") },\n                    modifier = Modifier.fillMaxWidth(),\n                    singleLine = true,\n                    keyboardOptions = KeyboardOptions(imeAction = ImeAction.Next)\n                )\n                Spacer(modifier = Modifier.height(8.dp))\n                OutlinedTextField(\n                    value = viewModel.title.value,\n                    onValueChange = { viewModel.title.value = it },\n                    label = { Text(\"Tiêu đề bài viết\") },\n                    modifier = Modifier.fillMaxWidth(),\n                    singleLine = true,\n                    keyboardOptions = KeyboardOptions(imeAction = ImeAction.Next)\n                )\n                Spacer(modifier = Modifier.height(8.dp))\n                OutlinedTextField(\n                    value = viewModel.content.value,\n                    onValueChange = { viewModel.content.value = it },\n                    label = { Text(\"Nội dung đánh giá của bạn...\") },\n                    modifier = Modifier.fillMaxWidth().height(150.dp),\n                )\n                Spacer(modifier = Modifier.height(8.dp))\n                OutlinedTextField(\n                    value = viewModel.pricePerPerson.value,\n                    onValueChange = { viewModel.pricePerPerson.value = it },\n                    label = { Text(\"Chi phí (trung bình / người)\") },\n                    modifier = Modifier.fillMaxWidth(),\n                    keyboardOptions = KeyboardOptions(\n                        keyboardType = KeyboardType.Number,\n                        imeAction = ImeAction.Done\n                    ),\n                    singleLine = true\n                )\n                Spacer(modifier = Modifier.height(16.dp))\n                Text(\"Xếp hạng\", style = MaterialTheme.typography.titleMedium)\n                RatingBar(rating = viewModel.rating.value, onRatingChange = { viewModel.rating.value = it })\n\n                Spacer(modifier = Modifier.height(16.dp))\n                Text(\"Hình ảnh\", style = MaterialTheme.typography.titleMedium)\n                ImageSelector(selectedUris = viewModel.imageUris.value) {\n                    imagePickerLauncher.launch(\"image/*\")\n                }\n\n                // Hiển thị lỗi nếu có\n                if (uiState is CreatePostUiState.Error) {\n                    Text(\n                        text = (uiState as CreatePostUiState.Error).message,\n                        color = MaterialTheme.colorScheme.error,\n                        modifier = Modifier.padding(top = 8.dp)\n                    )\n                }\n            }\n\n            // Hiển thị màn hình loading\n            if (uiState is CreatePostUiState.Loading) {\n                CircularProgressIndicator(modifier = Modifier.align(Alignment.Center))\n            }\n        }\n    }\n}\n\n@Composable\nfun RatingBar(rating: Int, onRatingChange: (Int) -> Unit) {\n    Row {\n        (1..5).forEach { index ->\n            IconButton(onClick = { onRatingChange(index) }) {\n                Icon(\n                    imageVector = Icons.Filled.Star,\n                    contentDescription = \"Star $index\",\n                    tint = if (index <= rating) MaterialTheme.colorScheme.primary else Color.Gray\n                )\n            }\n        }\n    }\n}\n\n@Composable\nfun ImageSelector(selectedUris: List<Uri>, onAddImageClick: () -> Unit) {\n    Column {\n        Button(onClick = onAddImageClick) {\n            Icon(Icons.Default.AddAPhoto, contentDescription = \"Thêm ảnh\")\n            Spacer(modifier = Modifier.width(8.dp))\n            Text(\"Chọn ảnh\")\n        }\n        Spacer(modifier = Modifier.height(8.dp))\n        LazyRow(horizontalArrangement = Arrangement.spacedBy(8.dp)) {\n            items(selectedUris) { uri ->\n                Image(\n                    painter = rememberAsyncImagePainter(uri),\n                    contentDescription = null,\n                    modifier = Modifier\n                        .size(100.dp)\n                        .clip(MaterialTheme.shapes.small),\n                    contentScale = ContentScale.Crop\n                )\n            }\n        }\n    }\n}\n